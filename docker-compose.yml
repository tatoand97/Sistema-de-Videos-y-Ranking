services:
  redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes"]
    ports: ["6379:6379"]
    volumes: [redis-data:/data]
    restart: unless-stopped
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 10s
      timeout: 3s
      retries: 5



  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: videorank
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    ports: ["5432:5432"]
    volumes: [pg-data:/var/lib/postgresql/data]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  migrate:
    image: migrate/migrate:4
    container_name: app_migrate
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./Api/internal/infrastructure/migrations:/migrations:ro
    environment:
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
    entrypoint: ["/bin/sh","-c"]
    command: |
      echo "Listing /migrations to verify mount:" \
      && ls -la /migrations \
      && /usr/local/bin/migrate -path=/migrations -database "$$DATABASE_URL" up
    restart: "no"

  api:
    build:
      context: ./Api
    container_name: app_api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
      JWT_SECRET: 6EPOc2/6veZ71FAJSF68iv21ho83NLQSaycHEGTTjGO9TBmRsphMp5JqgieFTcGn
      PORT: "8080"
      CORS_ORIGIN: "*"
      UPLOAD_DIR: "/uploads"

      # Redis cache configuration (used by API PublicService)
      REDIS_ADDR: redis:6379
      CACHE_PREFIX: "videorank:"
      CACHE_TTL_SECONDS: "120"

      # AWS credentials and SQS configuration
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      S3_BUCKET: ${RAW_VIDEOS_BUCKET}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-false}
      
      # SQS queues
      SQS_STATES_MACHINE_QUEUE: ${SQS_STATES_MACHINE_QUEUE}
      
      # Processed video URL configuration
      PROCESSED_VIDEO_BASE_URL: https://${PROCESSED_VIDEOS_FINAL_BUCKET}.s3.us-east-1.amazonaws.com
    restart: unless-stopped
    healthcheck:
      test: [ "CMD","wget","--no-verbose","--tries=1","--spider","http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "8080:8080" # API Proxy
      - "8081:8081" # Frontend estático
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  # TrimVideo Worker (1º - raw-videos → processed-videos-trim)
  trim-video:
    build:
      context: ./Workers
      dockerfile: TrimVideo/Dockerfile
    environment:
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-false}
      RAW_BUCKET: ${RAW_VIDEOS_BUCKET}
      PROCESSED_BUCKET: ${PROCESSED_VIDEOS_TRIM_BUCKET}
      SQS_QUEUE_URL: ${SQS_TRIM_VIDEO_QUEUE}
      SQS_STATE_MACHINE_QUEUE: ${SQS_STATES_MACHINE_QUEUE}
      MAX_SECONDS: "30"
      MAX_RETRIES: "3"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "trim"]
      interval: 30s
      timeout: 10s
      retries: 3

  # EditVideo Worker (2º - processed-videos-trim → processed-videos-edit)
  edit-video:
    build:
      context: ./Workers
      dockerfile: EditVideo/Dockerfile
    environment:
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-false}
      RAW_BUCKET: ${PROCESSED_VIDEOS_TRIM_BUCKET}
      PROCESSED_BUCKET: ${PROCESSED_VIDEOS_EDIT_BUCKET}
      SQS_QUEUE_URL: ${SQS_EDIT_VIDEO_QUEUE}
      SQS_STATE_MACHINE_QUEUE: ${SQS_STATES_MACHINE_QUEUE}
      MAX_SECONDS: "30"
      MAX_RETRIES: "3"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "edit"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AudioRemoval Worker (3º - processed-videos-edit → processed-videos-audio-removal)
  audio-removal:
    build:
      context: ./Workers
      dockerfile: AudioRemoval/Dockerfile
    environment:
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-false}
      RAW_BUCKET: ${PROCESSED_VIDEOS_EDIT_BUCKET}
      PROCESSED_BUCKET: ${PROCESSED_VIDEOS_AUDIO_REMOVAL_BUCKET}
      SQS_QUEUE_URL: ${SQS_AUDIO_REMOVAL_QUEUE}
      SQS_STATE_MACHINE_QUEUE: ${SQS_STATES_MACHINE_QUEUE}
      MAX_RETRIES: "3"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "audio"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Watermarking Worker (4º - processed-videos-audio-removal → processed-videos-watermarking)
  watermarking:
    build:
      context: ./Workers
      dockerfile: Watermarking/Dockerfile
    environment:
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-false}
      RAW_BUCKET: ${PROCESSED_VIDEOS_AUDIO_REMOVAL_BUCKET}
      PROCESSED_BUCKET: ${PROCESSED_VIDEOS_WATERMARKING_BUCKET}
      SQS_QUEUE_URL: ${SQS_WATERMARKING_QUEUE}
      SQS_STATE_MACHINE_QUEUE: ${SQS_STATES_MACHINE_QUEUE}
      MAX_SECONDS: "30"
      MAX_RETRIES: "3"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "watermark"]
      interval: 30s
      timeout: 10s
      retries: 3

  # StatesMachine Worker (Orchestrator)
  states-machine:
    build:
      context: ./Workers
      dockerfile: StatesMachine/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      trim-video:
        condition: service_healthy
      edit-video:
        condition: service_healthy
      audio-removal:
        condition: service_healthy
      watermarking:
        condition: service_healthy
      gossip-open-close:
        condition: service_healthy
      admin-cache:
        condition: service_healthy
    environment:
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      SQS_QUEUE_URL: ${SQS_STATES_MACHINE_QUEUE}
      SQS_TRIM_VIDEO_QUEUE: ${SQS_TRIM_VIDEO_QUEUE}
      SQS_EDIT_VIDEO_QUEUE: ${SQS_EDIT_VIDEO_QUEUE}
      SQS_AUDIO_REMOVAL_QUEUE: ${SQS_AUDIO_REMOVAL_QUEUE}
      SQS_WATERMARKING_QUEUE: ${SQS_WATERMARKING_QUEUE}
      SQS_GOSSIP_QUEUE: ${SQS_GOSSIP_QUEUE}
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
      MAX_RETRIES: "3"
      RETRY_DELAY_MINUTES: "5"
      
      # Processed video URL configuration
      PROCESSED_VIDEO_HOST: nginx
      PROCESSED_VIDEO_PORT: "8084"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "states"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # GossipOpenClose Worker (5º - processed-videos-watermarking → processed-videos)
  gossip-open-close:
    build:
      context: ./Workers
      dockerfile: gossipOpenClose/Dockerfile
    environment:
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-false}
      S3_BUCKET_RAW: ${PROCESSED_VIDEOS_WATERMARKING_BUCKET}
      S3_BUCKET_PROCESSED: ${PROCESSED_VIDEOS_FINAL_BUCKET}
      SQS_QUEUE_URL: ${SQS_GOSSIP_QUEUE}
      MAX_SECONDS: "30"
      INTRO_SECONDS: "2.5"
      OUTRO_SECONDS: "2.5"
      TARGET_WIDTH: "1280"
      TARGET_HEIGHT: "720"
      FPS: "30"
      LOGO_PATH: ./assets/nba-logo-removebg-preview.png
      MAX_RETRIES: "3"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "gossip"]
      interval: 30s
      timeout: 10s
      retries: 3

  admin-cache:
    build:
      context: ./Workers/AdminCache
    container_name: admin-cache
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
      REDIS_URL: redis://redis:6379
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "admin"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis-data:
  pg-data:
