services:
  redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes"]
    ports: ["6379:6379"]
    volumes: [redis-data:/data]
    restart: unless-stopped
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - rabbitmq-logs:/var/log/rabbitmq
      - ./rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD","rabbitmq-diagnostics","-q","ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: videorank
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    ports: ["5432:5432"]
    volumes: [pg-data:/var/lib/postgresql/data]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  migrate:
    image: migrate/migrate:4
    container_name: app_migrate
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./Api/internal/infrastructure/migrations:/migrations:ro
    environment:
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
    entrypoint: ["/bin/sh","-c"]
    command: |
      echo "Listing /migrations to verify mount:" \
      && ls -la /migrations \
      && /usr/local/bin/migrate -path=/migrations -database "$$DATABASE_URL" up
    restart: "no"

  api:
    build:
      context: ./Api
    container_name: app_api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-buckets:
        condition: service_completed_successfully
    environment:
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
      JWT_SECRET: 6EPOc2/6veZ71FAJSF68iv21ho83NLQSaycHEGTTjGO9TBmRsphMp5JqgieFTcGn
      PORT: "8080"
      CORS_ORIGIN: "*"
      UPLOAD_DIR: "/uploads"

      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio12345
      MINIO_BUCKET: raw-videos
      MINIO_USE_SSL: "false"
      # RabbitMQ to publish processing jobs
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      STATES_MACHINE_QUEUE: states_machine_queue
    restart: unless-stopped
    healthcheck:
      test: [ "CMD","wget","--no-verbose","--tries=1","--spider","http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  minio:
    image: minio/minio:latest
    command: ["server","/data","--console-address",":9001"]
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    ports: ["9000:9000","9001:9001"]
    volumes: [minio-data:/data]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio-buckets:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    entrypoint: >
      /bin/sh -c "
      until /usr/bin/mc alias set myminio http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD; do
        echo 'Waiting for MinIO to be ready...'
        sleep 2
      done;
      /usr/bin/mc mb myminio/raw-videos --ignore-existing;
      /usr/bin/mc mb myminio/processed-videos-trim --ignore-existing;
      /usr/bin/mc mb myminio/processed-videos-edit --ignore-existing;
      /usr/bin/mc mb myminio/processed-videos-audio-removal --ignore-existing;
      /usr/bin/mc mb myminio/processed-videos-watermarking --ignore-existing;
      /usr/bin/mc mb myminio/processed-videos --ignore-existing;
      echo 'Buckets created successfully';
      exit 0;
      "
    restart: "no"

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      api:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports:
      - "8080:8080" # API Proxy
      - "8082:8082" # MinIO Console
      - "8083:8083" # RabbitMQ UI
      - "8081:8081" # Frontend estático
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  # TrimVideo Worker (1º - raw-videos → processed-videos-trim)
  trim-video:
    build:
      context: ./Workers
      dockerfile: TrimVideo/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-buckets:
        condition: service_completed_successfully
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio12345
      RAW_BUCKET: raw-videos
      PROCESSED_BUCKET: processed-videos-trim
      QUEUE_NAME: trim_video_queue
      STATE_MACHINE_QUEUE: states_machine_queue
      MAX_SECONDS: "30"
      MAX_RETRIES: "3"
    restart: unless-stopped

  # EditVideo Worker (2º - processed-videos-trim → processed-videos-edit)
  edit-video:
    build:
      context: ./Workers
      dockerfile: EditVideo/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-buckets:
        condition: service_completed_successfully
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio12345
      RAW_BUCKET: processed-videos-trim
      PROCESSED_BUCKET: processed-videos-edit
      QUEUE_NAME: edit_video_queue
      STATE_MACHINE_QUEUE: states_machine_queue
      MAX_SECONDS: "30"
      MAX_RETRIES: "3"
    restart: unless-stopped

  # AudioRemoval Worker (3º - processed-videos-edit → processed-videos-audio-removal)
  audio-removal:
    build:
      context: ./Workers
      dockerfile: AudioRemoval/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-buckets:
        condition: service_completed_successfully
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio12345
      RAW_BUCKET: processed-videos-edit
      PROCESSED_BUCKET: processed-videos-audio-removal
      QUEUE_NAME: audio_removal_queue
      STATE_MACHINE_QUEUE: states_machine_queue
      MAX_RETRIES: "3"
    restart: unless-stopped

  # Watermarking Worker (4º - processed-videos-audio-removal → processed-videos-watermarking)
  watermarking:
    build:
      context: ./Workers
      dockerfile: Watermarking/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-buckets:
        condition: service_completed_successfully
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio12345
      RAW_BUCKET: processed-videos-audio-removal
      PROCESSED_BUCKET: processed-videos-watermarking
      QUEUE_NAME: watermarking_queue
      STATE_MACHINE_QUEUE: states_machine_queue
      MAX_SECONDS: "30"
      MAX_RETRIES: "3"
    restart: unless-stopped

  # StatesMachine Worker (Orchestrator)
  states-machine:
    build:
      context: ./Workers
      dockerfile: StatesMachine/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      QUEUE_NAME: states_machine_queue
      EDIT_VIDEO_QUEUE: edit_video_queue
      AUDIO_REMOVAL_QUEUE: audio_removal_queue
      WATERMARKING_QUEUE: watermarking_queue
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
      MAX_RETRIES: "3"
      RETRY_DELAY_MINUTES: "5"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "statesmachine"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # GossipOpenClose Worker (5º - processed-videos-watermarking → processed-videos)
  gossip-open-close:
    build:
      context: ./Workers
      dockerfile: gossipOpenClose/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-buckets:
        condition: service_completed_successfully
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio12345
      MINIO_BUCKET_RAW: processed-videos-watermarking
      MINIO_BUCKET_PROCESSED: processed-videos
      QUEUE_NAME: gossip_open_close_queue
      MAX_SECONDS: "30"
      INTRO_SECONDS: "2.5"
      OUTRO_SECONDS: "2.5"
      TARGET_WIDTH: "1280"
      TARGET_HEIGHT: "720"
      FPS: "30"
      LOGO_PATH: ./assets/nba-logo-removebg-preview.png
      MAX_RETRIES: "3"
    restart: unless-stopped

  admin-cache:
    build:
      context: ./Workers/AdminCache
    container_name: admin-cache
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://app_user:app_password@postgres:5432/videorank?sslmode=disable
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672/
      REDIS_URL: redis://redis:6379
    restart: unless-stopped

volumes:
  redis-data:
  rabbitmq-data:
  rabbitmq-logs:
  pg-data:
  minio-data:
